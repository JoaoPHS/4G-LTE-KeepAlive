name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  OPENWRT_VERSION: "23.05.5"
  TARGETS: "x86_64 ramips_mt76x8 ath79_generic"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - name: x86_64
            subtarget: generic
          - name: ramips
            subtarget: mt76x8
          - name: ath79
            subtarget: generic
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup OpenWrt SDK
        run: |
          TARGET_NAME="${{ matrix.target.name }}"
          SUBTARGET_NAME="${{ matrix.target.subtarget }}"
          SDK_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/${TARGET_NAME}/${SUBTARGET_NAME}/openwrt-sdk-${TARGET_NAME}-${SUBTARGET_NAME}-gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          
          wget -q "$SDK_URL" -O sdk.tar.xz
          tar -xf sdk.tar.xz
          mv openwrt-sdk-* openwrt-sdk
          echo "SDK_DIR=$(pwd)/openwrt-sdk" >> $GITHUB_ENV
      
      - name: Build package
        run: |
          cd openwrt-sdk
          mkdir -p ./package/4g-lte-keepalive
          cp -r ../Makefile ../src/* ./package/4g-lte-keepalive/
          make package/4g-lte-keepalive/compile V=s
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ipk-${{ matrix.target.name }}-${{ matrix.target.subtarget }}
          path: openwrt-sdk/bin/packages/*/base/*.ipk
          retention-days: 30
  
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release files
        run: |
          mkdir -p release-packages
          find artifacts -name "*.ipk" -exec cp {} release-packages/ \;
          echo "Found IPK files:"
          ls -lh release-packages/
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-packages/*.ipk
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

